# kodb-util
`kodb-util` is a database utility tool created to help in the development of the OpenKO project.

The utility aims to:

1. Create/Import the OpenKO database structure and data
2. Export the structure, data, and jsonSchema database properties from the configured database

## Program configuration
Configure your database connection information in `kodb-util-config.yaml`. As this file is on `.gitignore` a template is provided in `kodb-util-config.yaml.template`

This utility mutates the configured user (default: `knight`) as part of its import and export functionality.  For local development you can:
* Leave databaseConfig.user blank to use Windows Authentication
* use your `sa` login
* configure a user with similar permissions

You'll need a copy of [OpenKO-db](https://github.com/Open-KO/OpenKO-db) to run this program against.  This is set up as a git submodule (explained below), but 
you can override it in your settings with `genConfig.schemaDir`.

## Dependencies
The following commands assume that you have a terminal open in the root folder of the project.

The `OpenKO-db` project is a submodule; we make use of:
* `OpenKO-db/templates` to generate databases, schemas, users, and logins
* `OpenKO-db/jsonSchema/tableDef.go` structures to bind the json schema during -exportJsonSchema

We update/generate the content of:
* `OpenKO-db/jsonSchema`: the -exportJsonSchema flag reads the table structure of the database and syncs the *.json properties
* `OpenKO-db/ManualSetup`: contains the *.sql files generated by the export functions. These files are used by the import process to populate a database

To fetch or update the submodule(s):
```shell
git submodule update --init --recursive --remote
```

This utility is programmed with Go 1.24+.  You'll need to install the language if you want to build locally. See https://go.dev/doc/install

If Go is correctly installed on your path, you should be able to run `go version` in your terminal and get version
information output:
```
PS C:\> go version
go version go1.24.1 windows/amd64
```
To download Go dependencies, run:
```shell
go mod download
```

To run the application, run:
```shell
go run kodb-util.go
```

Without any arguments (or -usage), you should get a usage prompt like this:
```
------------------------------------------------------------------------------------------------------------------------
                                               OpenKO Database Utilities
------------------------------------------------------------------------------------------------------------------------
No arguments provided:
Usage of kodb-util.exe:
  -batchSize int
        Batch sized used when importing table data.  Valid range [2-999], if invalid value specified will default to 16 (default 16)
  -clean
        Clean drops any configured users and drops the databaseConfig.dbname database
        Path to config file, inclusive of the filename (default "kodb-util-config.yaml")
  -dbpass string
        Database connection password override
  -dbuser string
        Database connection user override
  -exportAll
        Export both the data and structure of the database
  -exportData
        Export table data from the database
  -exportJsonSchema
        Export table properties from the database to update jsonSchema.  Not part of -exportAll
  -exportProcs
        Export the stored procedures of the database
  -exportStructure
        Export the structural elements of the database
  -exportViews
        Export the views of the database
  -import
        Runs clean and imports the contents of OpenKO-db/ManaualSetup, StoredProcedures, and Views
  -schema string
        OpenKO-db schema directory override; in most cases you'll just want to use the default git submodule location
```

## Building the utility program
To build `kodb-util.exe`, run the following command in this directory:
```shell
go build
```

## Troubleshooting

### Error: unable to open tcp connection
```
unable to open tcp connection with host 'localhost:1433': dial tcp [::1]:1433: connectex: No connection could be made because the target machine actively refused it.
```

### Likely Solution

You need to configure SQLServer to accept connections on the port specified in your configuration, or update your configuration 
with the port used by your SQL Server instance.  The following steps will configure SQL Server to listen on port 1433.

1. Open Sql Server Configuration Manager
2. Expand `SQL Server Network Configuration`
3. Select `Protocols for SQLEXPRESS` (or whatever edition you have installed)
4. In the right pane, right click `TCP/IP` > Properties
5. Go to the IP Addresses Tab, find the `IPAll` entry and enter your port (default: 1433) in the `TCP Port` field.
6. Click OK to close the dialog box
7. In the right pane, right click `TCP/IP` and select Enable.
8. In the left pane, right click `SQL Server Services`
9. In the right pane, right click `SQL Server (Instance Name)` and select Restart.